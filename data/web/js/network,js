// network.js - JavaScript para gerenciamento de redes WiFi

let currentNetworkInfo = {
    ssid: '',
    ip: '',
    status: '',
    rssi: 0
};

let availableNetworks = [];

// Fun√ß√£o para carregar informa√ß√µes da rede atual
async function loadNetworkInfo() {
    try {
        const response = await fetch('/api/network/status');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì° Informa√ß√µes de rede:', data);
        
        currentNetworkInfo.ssid = data.ssid || 'Desconectado';
        currentNetworkInfo.ip = data.ip || 'N/A';
        currentNetworkInfo.status = data.status || 'Desconhecido';
        currentNetworkInfo.rssi = data.rssi || 0;
        
        updateNetworkUI();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar informa√ß√µes de rede:', error);
        showError('Erro ao carregar informa√ß√µes de rede: ' + error.message);
    }
}

// Fun√ß√£o para buscar redes dispon√≠veis
async function scanNetworks() {
    try {
        showLoading('Buscando redes WiFi...');
        
        const response = await fetch('/api/network/scan');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì∂ Redes encontradas:', data);
        
        availableNetworks = data.networks || [];
        updateNetworkList();
        showSuccess(`Encontradas ${availableNetworks.length} redes`);
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar redes:', error);
        showError('Erro ao buscar redes: ' + error.message);
    }
}

// Fun√ß√£o para atualizar a lista de redes no select
function updateNetworkList() {
    const wifiSelect = document.getElementById('wifiScan');
    wifiSelect.innerHTML = '<option value="">Selecione uma rede</option>';
    
    availableNetworks.forEach(network => {
        const option = document.createElement('option');
        option.value = network.ssid;
        
        // Mostrar for√ßa do sinal com √≠cones
        let signalIcon = 'üì∂';
        if (network.rssi > -50) signalIcon = 'üì∂';
        else if (network.rssi > -70) signalIcon = 'üì∂';
        else signalIcon = 'üì∂';
        
        // Mostrar se √© segura
        const security = network.encryption !== 'OPEN' ? 'üîí' : 'üîì';
        
        option.textContent = `${signalIcon} ${security} ${network.ssid} (${network.rssi} dBm)`;
        wifiSelect.appendChild(option);
    });
    
    // Adicionar op√ß√£o para rede oculta
    const hiddenOption = document.createElement('option');
    hiddenOption.value = "hidden";
    hiddenOption.textContent = "üåê Rede Ocultra (digite o nome manualmente)";
    wifiSelect.appendChild(hiddenOption);
}

// Fun√ß√£o chamada quando uma rede √© selecionada da lista
function networkSelected() {
    const wifiSelect = document.getElementById('wifiScan');
    const ssidInput = document.getElementById('ssid');
    
    if (wifiSelect.value && wifiSelect.value !== "hidden") {
        ssidInput.value = wifiSelect.value;
    } else if (wifiSelect.value === "hidden") {
        ssidInput.value = "";
        ssidInput.focus();
        ssidInput.placeholder = "Digite o nome da rede oculta";
    }
}

// Fun√ß√£o para salvar configura√ß√£o WiFi
async function saveWiFiConfig() {
    try {
        const ssid = document.getElementById('ssid').value.trim();
        const password = document.getElementById('password').value;
        
        if (!ssid) {
            showError('Por favor, informe o SSID da rede');
            return;
        }
        
        showLoading('Conectando √† rede...');
        
        const config = {
            ssid: ssid,
            password: password
        };
        
        console.log('üì§ Enviando configura√ß√£o WiFi:', { ...config, password: '***' });
        
        const response = await fetch('/api/network/connect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Resposta da conex√£o:', result);
        
        showConnectionStatus('Conectando √† rede ' + ssid + '...', 'info');
        
        // Monitorar status da conex√£o
        monitorConnection(ssid);
        
    } catch (error) {
        console.error('‚ùå Erro ao conectar:', error);
        showError('Erro ao conectar: ' + error.message);
        showConnectionStatus('Falha na conex√£o: ' + error.message, 'error');
    }
}

// Fun√ß√£o para monitorar o status da conex√£o
async function monitorConnection(ssid) {
    let attempts = 0;
    const maxAttempts = 30; // 30 tentativas (30 segundos)
    
    const interval = setInterval(async () => {
        attempts++;
        
        try {
            const response = await fetch('/api/network/status');
            if (response.ok) {
                const status = await response.json();
                
                if (status.ssid === ssid && status.status === 'Conectado') {
                    clearInterval(interval);
                    showConnectionStatus('‚úÖ Conectado com sucesso √† rede ' + ssid, 'success');
                    showSuccess('Conectado √† rede ' + ssid);
                    loadNetworkInfo(); // Atualizar informa√ß√µes
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    showConnectionStatus('‚ùå Timeout: N√£o foi poss√≠vel conectar √† rede', 'error');
                    showError('Timeout na conex√£o com ' + ssid);
                }
            }
        } catch (error) {
            console.error('Erro ao verificar status:', error);
        }
        
        if (attempts >= maxAttempts) {
            clearInterval(interval);
            showConnectionStatus('‚ùå Timeout: N√£o foi poss√≠vel conectar √† rede', 'error');
        }
    }, 1000);
}

// Fun√ß√£o para limpar configura√ß√£o WiFi
async function clearWiFiConfig() {
    if (!confirm('Tem certeza que deseja limpar a configura√ß√£o WiFi atual?')) {
        return;
    }
    
    try {
        showLoading('Limpando configura√ß√£o...');
        
        const response = await fetch('/api/network/clear', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        showSuccess('Configura√ß√£o WiFi limpa. O ESP32 reiniciar√° no modo AP.');
        showConnectionStatus('Configura√ß√£o limpa. Reiniciando...', 'info');
        
        // Recarregar ap√≥s um tempo
        setTimeout(() => {
            loadNetworkInfo();
        }, 3000);
        
    } catch (error) {
        console.error('‚ùå Erro ao limpar configura√ß√£o:', error);
        showError('Erro ao limpar configura√ß√£o: ' + error.message);
    }
}

// Fun√ß√£o para atualizar a UI com informa√ß√µes da rede
function updateNetworkUI() {
    document.getElementById('currentSSID').textContent = currentNetworkInfo.ssid;
    document.getElementById('currentIP').textContent = currentNetworkInfo.ip;
    document.getElementById('wifiStatus').textContent = currentNetworkInfo.status;
    
    // Atualizar for√ßa do sinal
    const signalElement = document.getElementById('signalStrength');
    if (currentNetworkInfo.rssi === 0) {
        signalElement.textContent = 'N/A';
    } else {
        let signalText = `${currentNetworkInfo.rssi} dBm - `;
        if (currentNetworkInfo.rssi > -50) signalText += 'Excelente';
        else if (currentNetworkInfo.rssi > -60) signalText += 'Bom';
        else if (currentNetworkInfo.rssi > -70) signalText += 'Regular';
        else signalText += 'Ruim';
        
        signalElement.textContent = signalText;
    }
}

// Fun√ß√£o para mostrar status da conex√£o
function showConnectionStatus(message, type) {
    const statusElement = document.getElementById('connectionStatus');
    statusElement.style.display = 'block';
    
    const colors = {
        success: 'var(--success)',
        error: 'var(--error)',
        info: 'var(--accent-primary)',
        warning: 'var(--warning)'
    };
    
    statusElement.innerHTML = `
        <div style="background: ${colors[type]}; color: white; padding: 1rem; border-radius: 0.5rem; text-align: center;">
            ${message}
        </div>
    `;
}

// Fun√ß√£o para alternar modo AP
function toggleAPMode() {
    const apConfigGroup = document.getElementById('apConfigGroup');
    const enableAP = document.getElementById('enableAP').checked;
    
    apConfigGroup.style.display = enableAP ? 'block' : 'none';
}

// Fun√ß√£o para salvar configura√ß√£o AP
async function saveAPConfig() {
    try {
        const apSSID = document.getElementById('apSSID').value.trim();
        const apPassword = document.getElementById('apPassword').value;
        
        if (!apSSID) {
            showError('Por favor, informe o nome do Access Point');
            return;
        }
        
        showLoading('Salvando configura√ß√£o AP...');
        
        const config = {
            ap_ssid: apSSID,
            ap_password: apPassword
        };
        
        const response = await fetch('/api/network/ap-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        showSuccess('Configura√ß√£o do Access Point salva com sucesso');
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar configura√ß√£o AP:', error);
        showError('Erro ao salvar configura√ß√£o AP: ' + error.message);
    }
}

// Fun√ß√µes auxiliares
function showLoading(message = 'Carregando...') {
    console.log('‚è≥ ' + message);
}

function showSuccess(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 1rem;
        border-radius: 0.375rem;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = '‚úÖ ' + message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showError(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--error);
        color: white;
        padding: 1rem;
        border-radius: 0.375rem;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = '‚ùå ' + message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Inicializa√ß√£o quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina de rede inicializada');
    
    // Carrega informa√ß√µes da rede atual
    loadNetworkInfo();
    
    // Configurar evento no select de redes
    document.getElementById('wifiScan').addEventListener('change', networkSelected);
    
    // Atualizar informa√ß√µes do sistema
    updateSystemInfo();
    setInterval(updateSystemInfo, 30000);
});

// Fun√ß√µes para atualizar tempo e uptime
function updateCurrentTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = 
        now.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
}

async function updateSystemInfo() {
    try {
        const response = await fetch('/api/uptime');
        if (response.ok) {
            const uptime = await response.text();
            document.getElementById('uptime').textContent = `Uptime: ${uptime}`;
        }
    } catch (error) {
        console.log('N√£o foi poss√≠vel atualizar uptime');
    }
    
    updateCurrentTime();
}

setInterval(updateCurrentTime, 1000);